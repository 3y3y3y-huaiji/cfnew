# 部署配置指南

日期：2025-11-21
更新人：项目维护者

## 1. 项目概述

本项目是一个基于Cloudflare Workers的多协议代理服务，使用Cloudflare Workers平台进行部署。本指南将详细说明如何配置应用程序的命名、构建命令、部署命令、API令牌等设置。

## 2. 应用程序命名

### 2.1 项目名称

- **建议名称**：CFnew Proxy
- **说明**：项目名称应简洁明了，能够准确反映项目的功能和用途。
- **使用场景**：
  - Cloudflare Workers控制台中的应用名称
  - GitHub仓库名称（已设置为cfnew）
  - 部署后的服务名称

## 3. 构建命令配置

### 3.1 构建命令（主要）

Cloudflare Workers项目通常不需要复杂的构建过程，因为它直接使用JavaScript代码。但本项目包含代码混淆步骤，所以构建命令包括代码混淆。

- **命令**：`npm install && node obfuscate.js`
- **说明**：
  - `npm install`：安装项目依赖（主要是javascript-obfuscator）
  - `node obfuscate.js`：运行代码混淆脚本

### 3.2 构建命令脚本（obfuscate.js）

创建以下构建脚本文件（已存在于项目中）：

```javascript
const JavaScriptObfuscator = require('javascript-obfuscator');
const fs = require('fs');
const path = require('path');

const sourceFileName = '少年你相信光吗'; // 使用混淆后的文件作为源
const outputFileName = '少年你相信光吗'; // 输出到同一个文件
const sourceFilePath = path.join(process.cwd(), sourceFileName);

if (!fs.existsSync(sourceFilePath)) {
  console.error('错误：在路径 \'' + sourceFilePath + '\' 未找到源文件。请确保您的仓库根目录有名为 \'' + sourceFileName + '\' 的文件。');
  process.exit(1);
}

const originalCode = fs.readFileSync(sourceFilePath, 'utf8');

if (!originalCode || originalCode.trim().length === 0) {
  console.error('错误：源文件 ' + sourceFileName + ' 为空。');
  process.exit(1);
}

const obfuscationOptions = {
    compact: true,
    controlFlowFlattening: false,
    controlFlowFlatteningThreshold: 0,
    deadCodeInjection: false,
    stringArray: true,
    stringArrayEncoding: ['base64'],
    stringArrayThreshold: 1.0,
    stringArrayRotate: true,
    stringArrayShuffle: true,
    stringArrayWrappersCount: 2,
    stringArrayWrappersChainedCalls: false,
    stringArrayWrappersParametersMaxCount: 3,
    renameGlobals: true,
    identifierNamesGenerator: 'mangled-shuffled',
    identifierNamesCache: null,
    identifiersPrefix: '',
    renameProperties: false,
    renamePropertiesMode: 'safe',
    ignoreImports: false,
    target: 'browser',
    numbersToExpressions: false,
    simplify: false,
    splitStrings: true,
    splitStringsChunkLength: 1,
    transformObjectKeys: false,
    unicodeEscapeSequence: true,
    selfDefending: false,
    debugProtection: false,
    debugProtectionInterval: 0,
    disableConsoleOutput: true,
    domainLock: []
};

const obfuscatedCode = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions).getObfuscatedCode();

fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
console.log('成功将 \'' + sourceFileName + '\' 混淆并保存至 \'' + outputFileName + '\'。');
```

## 4. 部署命令配置

### 4.1 部署命令（主要）

使用Cloudflare Workers CLI工具（wrangler）进行部署：

- **命令**：`npx wrangler deploy`
- **说明**：
  - 首先需要安装wrangler：`npm install -g wrangler`
  - 登录Cloudflare账号：`npx wrangler login`

### 4.2 部署配置文件（wrangler.toml）

创建以下wrangler配置文件：

```toml
name = "cfnew-proxy"
main = "_worker.js"
compatibility_date = "2023-01-01"

[[kv_namespaces]]
binding = "KV_CONFIG"
id = "YOUR_KV_NAMESPACE_ID"
preview_id = "YOUR_KV_NAMESPACE_PREVIEW_ID"

[vars]
DEFAULT_PROTOCOL = "vless"
DEFAULT_PATH = "/"
# 其他环境变量...
```

### 4.3 环境变量配置

在wrangler.toml或Cloudflare Workers控制台中配置以下环境变量：

| 变量名称 | 值示例 | 说明 |
|---------|-------|------|
| DEFAULT_PROTOCOL | "vless" | 默认协议 |
| DEFAULT_PATH | "/" | 默认访问路径 |
| CUSTOM_PATH | "/myproxy" | 自定义访问路径（可选） |
| TROJAN_PASSWORD | "your_password" | Trojan协议密码 |
| SUBSCRIPTION_URL | "https://your-subscription-url" | 订阅转换服务URL |

## 5. 非生产分支构建配置

### 5.1 非生产分支构建

- **分支名称**：
  - 开发分支：`dev`
  - 测试分支：`test`

- **构建触发条件**：
  - 当推送到`dev`或`test`分支时自动触发构建
  - 不部署到生产环境，仅用于测试

### 5.2 非生产分支部署命令（可选）

- **命令**：`npx wrangler deploy --env dev`
- **说明**：部署到开发环境

## 6. 高级设置

### 6.1 路径配置

- **主路径**：`_worker.js`
- **说明**：Cloudflare Workers的入口文件路径
- **其他路径**：
  - 静态资源路径：`/assets`（如果有静态资源）
  - API路径：`/api/*`

### 6.2 API令牌配置

#### 6.2.1 Cloudflare API令牌

- **用途**：用于通过API部署和管理Cloudflare Workers
- **创建步骤**：
  1. 登录Cloudflare控制台
  2. 转到"My Profile" > "API Tokens"
  3. 点击"Create Token"
  4. 选择"Edit Cloudflare Workers"
  5. 按照提示完成配置并生成令牌

- **配置方式**：
  - 设置环境变量：`CF_API_TOKEN=your_token_here`
  - 或在wrangler.toml中配置：
    ```toml
    [env.production]
    api_token = "your_token_here"
    ```

#### 6.2.2 Hugo Blog Build Token

- **用途**：如果项目与Hugo博客集成，用于触发博客构建
- **配置方式**：
  - 设置环境变量：`HUGO_BLOG_BUILD_TOKEN=your_token_here`
  - 在GitHub Actions中使用：
    ```yaml
    env:
      HUGO_BLOG_BUILD_TOKEN: ${{ secrets.HUGO_BLOG_BUILD_TOKEN }}
    ```

## 7. 变量配置

### 7.1 变量名称和值

| 变量名称 | 值示例 | 说明 | 类型 |
|---------|-------|------|------|
| NODE_ENV | "production" | 运行环境 | 必填 |
| CF_API_TOKEN | "your_cf_token" | Cloudflare API令牌 | 必填 |
| KV_NAMESPACE_ID | "your_kv_id" | KV命名空间ID | 必填 |
| DEFAULT_PROTOCOL | "vless" | 默认协议 | 可选 |
| CUSTOM_PATH | "/myproxy" | 自定义路径 | 可选 |
| TROJAN_PASSWORD | "your_password" | Trojan密码 | 可选 |
| SUBSCRIPTION_URL | "https://sub.example.com" | 订阅URL | 可选 |
| HUGO_BLOG_BUILD_TOKEN | "your_hugo_token" | Hugo构建令牌 | 可选 |

## 8. GitHub Actions工作流配置

项目已包含GitHub Actions工作流，位于`.github/workflows/obfuscate.yml`，用于自动构建和混淆代码。

### 8.1 工作流配置说明

- **触发条件**：
  - 手动触发：`workflow_dispatch`
  - 推送触发：当推送到任何分支时，且仅当`少年你相信光吗`文件有变化时

- **工作流步骤**：
  1. 检出代码
  2. 设置Node.js环境
  3. 安装依赖
  4. 运行代码混淆脚本
  5. 提交并推送混淆后的代码

## 9. 部署验证

部署完成后，使用以下方法验证部署是否成功：

1. **访问服务URL**：`https://cfnew-proxy.YOUR_DOMAIN.workers.dev`
2. **检查Cloudflare Workers控制台**：确认部署状态为"Active"
3. **测试功能**：使用客户端工具测试代理功能

## 10. 常见问题与解决方案

### 10.1 部署失败

- **问题**：`Error: Failed to deploy worker.`
- **解决方案**：
  1. 检查API令牌是否有效
  2. 检查wrangler.toml配置是否正确
  3. 检查_worker.js文件是否存在且格式正确

### 10.2 构建失败

- **问题**：`Error: Cannot find module 'javascript-obfuscator'`
- **解决方案**：运行`npm install`安装依赖

### 10.3 变量未生效

- **问题**：环境变量未在应用中生效
- **解决方案**：
  1. 检查变量名称是否正确
  2. 检查变量值是否正确配置
  3. 重新部署应用以加载新的变量

## 11. 总结

本指南详细说明了如何配置Cloudflare Workers应用程序的命名、构建命令、部署命令、API令牌等设置。按照本指南的步骤进行配置，您应该能够成功部署和管理CFnew Proxy应用程序。

如需更多帮助，请参考Cloudflare Workers官方文档：https://developers.cloudflare.com/workers/