# 需求文档

日期：2025-11-21
需求提出人：用户

## 项目概述
CFnew是一个基于Cloudflare Workers的多协议代理服务，提供VLESS、Trojan和xhttp等多种协议支持，具有自定义路径、代码混淆、订阅转换、图形化管理等核心特性。

## 核心功能需求

### 1. 多协议支持
- 支持VLESS协议（默认启用）
- 支持Trojan协议（默认禁用）
- 支持xhttp协议（默认禁用）
- 协议可独立启用/禁用
- Trojan协议支持自定义密码

### 2. 自定义路径
- 支持自定义访问路径，替代UUID路径
- 支持多级路径，如`/path/to/sub`
- 自动补全路径开头的斜杠
- 自定义路径后UUID路径自动禁用

### 3. 代码混淆增强
- 敏感关键词Base64编码
- 变量名混淆
- 移除调试语句
- 特征隐藏

### 4. 订阅转换
- 支持自定义订阅转换服务URL
- 细粒度控制优选域名、IP、GitHub优选
- 每种优选类型可独立启用/禁用

### 5. 图形化管理
- 使用Cloudflare KV存储持久化配置
- 访问`/{UUID}`或`/{自定义路径}`即可使用
- 无需重新部署，配置立即生效
- 配置优先级：KV配置 > 环境变量 > 默认值

### 6. API管理
- RESTful API支持
- 批量操作优选IP
- 动态更新配置

### 7. 多客户端支持
- 支持10种客户端：CLASH、SURGE、SING-BOX、LOON、QUANTUMULT X、V2RAY、Shadowrocket、STASH、NEKORAY、V2RAYNG
- 自动转换配置格式
- 一键获取订阅链接
- 应用唤醒功能
- 自动识别客户端类型

### 8. 多语言支持
- 自动语言检测
- 支持中文和波斯语
- RTL布局支持

### 9. 自动构建与混淆
- 实现从仓库自动构建的效果，无需手动复制源代码
- 确保仓库中不出现明文源码，只包含混淆后的代码
- 自动构建过程包含完整的代码混淆步骤
- 构建产物可直接部署到Cloudflare Workers

### 10. 远程仓库同步
- 将本地项目同步到指定的GitHub远程仓库
- 确保所有文件（包括混淆后的代码、文档和配置文件）都正确推送到远程仓库
- 保持本地和远程仓库的一致性

### 11. 构建失败修复
- 解决GitHub Actions构建失败问题："error occurred while updating repository submodules"
- 确保项目可以成功通过自动构建流程
- 在GitHub Actions工作流中禁用子模块更新，避免不必要的子模块检查
- 修改两个工作流文件（obfuscate.yml和test.yml），在checkout步骤中添加submodules: false配置
- 进一步增强工作流配置，添加fetch-depth、filter和sparse-checkout参数，彻底禁用子模块更新机制
- 重新初始化Git仓库，清除所有可能存在的子模块配置或引用

### 12. Git配置
- 配置Git的邮箱为真实邮箱sumingkai1@outlook.com
- 配置Git的用户名为"安卓人"

### 13. pnpm迁移与构建优化
- 从npm迁移到pnpm包管理器以加速构建
- 生成pnpm-lock.yaml文件确保依赖一致性
- 更新package.json中的scripts配置以适配pnpm
- 确保Cloudflare构建环境支持pnpm
- 彻底解决Cloudflare构建时的子模块更新错误

## 验收标准
1. 所有核心功能正常运行
2. 配置修改实时生效
3. 多客户端配置生成正确
4. API接口正常响应
5. 代码混淆有效隐藏特征
6. 多语言切换正常
7. 本地项目成功同步到指定的GitHub远程仓库
8. 远程仓库包含所有必要的文件，无遗漏
9. 自动构建与混淆功能正常工作
10. 构建产物无明文源码

## 变更记录

1. 2025-11-20 13:00: 配置Git邮箱和用户名
2. 2025-11-21 13:30: 迁移到pnpm包管理器以加速构建
3. 2025-11-21 13:30: 彻底解决Cloudflare构建时的子模块更新错误
4. 2025-11-21 14:00: 删除npm相关内容，清理项目依赖文件
5. 2025-11-21 14:30: 提交更改到GitHub仓库，完成项目同步
